import 'dart:async';
import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_database/firebase_database.dart';
import 'package:intl/intl.dart';
import 'firebase_options.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.blue),
        useMaterial3: true,
      ),
      home: const HomeScreen(),
    );
  }
}

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  final DatabaseReference _dbRef = FirebaseDatabase.instance.ref();

  StreamSubscription? _logicSubscription;
  bool _lastPirState = false;
  bool _lastGasState = false; // ƒê·ªÉ ph√°t hi·ªán c·∫°nh l√™n c·ªßa b√°o ƒë·ªông ch√°y
  bool _firstRun = true;

  @override
  void initState() {
    super.initState();
    // L·∫Øng nghe Firebase ƒë·ªÉ x·ª≠ l√Ω logic ƒë·∫øm kh√°ch t·ª± ƒë·ªông
    _logicSubscription = _dbRef.child('NhaThongMinh').onValue.listen((event) {
      if (event.snapshot.value == null) return;
      final data = Map<dynamic, dynamic>.from(event.snapshot.value as Map);

      // L·∫•y tr·∫°ng th√°i PIR v√† Gas (C·∫ßn ESP32 g·ª≠i key 'TrangThaiPIR')
      bool currentPir = data['TrangThaiPIR'] == true;
      bool isGasAlert = data['CanhBaoGas'] == true;

      if (!_firstRun) {
        // Logic: N·∫øu PIR chuy·ªÉn t·ª´ 0 -> 1 (c√≥ ng∆∞·ªùi v√†o) V√Ä kh√¥ng ph·∫£i do Gas b√°o ƒë·ªông
        if (currentPir && !_lastPirState && !isGasAlert) {
          int currentTotal = (data['TongKhach'] is int) ? data['TongKhach'] : 0;
          _dbRef.child('NhaThongMinh/TongKhach').set(currentTotal + 1);
        }

        // X·ª≠ l√Ω l∆∞u l·ªãch s·ª≠ (Min/Max/Ch√°y/Kh√°ch)
        _processHistoryLogic(data);
      }
      _lastPirState = currentPir;
      _lastGasState = isGasAlert;
      _firstRun = false;
    });
  }

  @override
  void dispose() {
    _logicSubscription?.cancel();
    super.dispose();
  }

  // H√†m x·ª≠ l√Ω logic l∆∞u l·ªãch s·ª≠
  void _processHistoryLogic(Map<dynamic, dynamic> data) async {
    final String today = DateFormat('yyyy-MM-dd').format(DateTime.now());
    final DatabaseReference historyRef = _dbRef.child('History/$today');

    // L·∫•y gi√° tr·ªã hi·ªán t·∫°i
    final double temp = (data['NhietDo'] is num) ? (data['NhietDo'] as num).toDouble() : 0.0;
    final double hum = (data['DoAm'] is num) ? (data['DoAm'] as num).toDouble() : 0.0;
    final int gas = (data['KhiGas'] is int) ? data['KhiGas'] : 0;
    final int totalGuests = (data['TongKhach'] is int) ? data['TongKhach'] : 0;
    final bool isGasAlert = data['CanhBaoGas'] == true;

    // L·∫•y d·ªØ li·ªáu l·ªãch s·ª≠ hi·ªán t·∫°i c·ªßa ng√†y h√¥m nay ƒë·ªÉ so s√°nh
    final DataSnapshot snapshot = await historyRef.get();
    
    if (snapshot.exists) {
      final historyData = Map<dynamic, dynamic>.from(snapshot.value as Map);
      
      // C·∫≠p nh·∫≠t Min/Max Nhi·ªát ƒë·ªô
      double maxTemp = (historyData['NhietDo']?['Max'] ?? temp).toDouble();
      double minTemp = (historyData['NhietDo']?['Min'] ?? temp).toDouble();
      if (temp > maxTemp) historyRef.child('NhietDo/Max').set(temp);
      if (temp < minTemp) historyRef.child('NhietDo/Min').set(temp);

      // C·∫≠p nh·∫≠t Min/Max ƒê·ªô ·∫©m
      double maxHum = (historyData['DoAm']?['Max'] ?? hum).toDouble();
      double minHum = (historyData['DoAm']?['Min'] ?? hum).toDouble();
      if (hum > maxHum) historyRef.child('DoAm/Max').set(hum);
      if (hum < minHum) historyRef.child('DoAm/Min').set(hum);

      // C·∫≠p nh·∫≠t Min/Max Kh√≠ Gas
      int maxGas = (historyData['KhiGas']?['Max'] ?? gas).toInt();
      int minGas = (historyData['KhiGas']?['Min'] ?? gas).toInt();
      if (gas > maxGas) historyRef.child('KhiGas/Max').set(gas);
      if (gas < minGas) historyRef.child('KhiGas/Min').set(gas);

      // C·∫≠p nh·∫≠t s·ªë l·∫ßn ch√°y (Ch·ªâ c·ªông khi chuy·ªÉn t·ª´ Kh√¥ng -> C√≥ b√°o ƒë·ªông)
      if (isGasAlert && !_lastGasState) {
        int fireCount = (historyData['SoLanChay'] ?? 0) + 1;
        historyRef.child('SoLanChay').set(fireCount);
      }

      // C·∫≠p nh·∫≠t t·ªïng kh√°ch (Lu√¥n ƒë·ªìng b·ªô v·ªõi hi·ªán t·∫°i)
      historyRef.child('TongKhach').set(totalGuests);

    } else {
      // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu ng√†y h√¥m nay, t·∫°o m·ªõi
      historyRef.set({
        'TongKhach': totalGuests,
        'SoLanChay': isGasAlert ? 1 : 0,
        'NhietDo': {'Max': temp, 'Min': temp},
        'DoAm': {'Max': hum, 'Min': hum},
        'KhiGas': {'Max': gas, 'Min': gas},
        'Timestamp': ServerValue.timestamp,
      });
    }
  }

  // H√†m format gi√° tr·ªã hi·ªÉn th·ªã
  String _formatValue(dynamic val, {String suffix = ""}) {
    if (val == null) return "0";
    if (val is double) return val.toInt().toString();
    if (val is int) return val.toString();
    return val.toString().split('.')[0] + suffix;
  }

  // H√†m reset t·ªïng kh√°ch (v√≠ d·ª•: qua ng√†y m·ªõi)
  void _resetDailyCounter() {
    _dbRef.child('NhaThongMinh/TongKhach').set(0);
    _dbRef.child('NhaThongMinh/KhachHienTai').set(0);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey[100],
      appBar: AppBar(
        title: const Text("Qu·∫£n L√Ω C·ª≠a H√†ng", style: TextStyle(fontWeight: FontWeight.bold)),
        centerTitle: true,
        backgroundColor: Theme.of(context).colorScheme.primaryContainer,
        actions: [
          IconButton(
            icon: const Icon(Icons.history),
            tooltip: "Xem l·ªãch s·ª≠",
            onPressed: () {
              Navigator.push(context, MaterialPageRoute(builder: (context) => const HistoryScreen()));
            },
          ),
          IconButton(
            icon: const Icon(Icons.refresh),
            tooltip: "Reset ƒë·∫øm kh√°ch",
            onPressed: _resetDailyCounter,
          )
        ],
      ),
      body: StreamBuilder(
        // L·∫Øng nghe node NhaThongMinh theo ƒë√∫ng c·∫•u tr√∫c code ESP32
        stream: _dbRef.child('NhaThongMinh').onValue,
        builder: (context, AsyncSnapshot<DatabaseEvent> snapshot) {
          if (snapshot.hasData && snapshot.data!.snapshot.value != null) {
            final Map<dynamic, dynamic> data = Map<dynamic, dynamic>.from(
                snapshot.data!.snapshot.value as Map);

            // Parse d·ªØ li·ªáu t·ª´ Firebase (kh·ªõp v·ªõi code ESP32)
            final double temp = (data['NhietDo'] is num) ? (data['NhietDo'] as num).toDouble() : 0.0;
            final double hum = (data['DoAm'] is num) ? (data['DoAm'] as num).toDouble() : 0.0;
            final int gas = (data['KhiGas'] is int) ? data['KhiGas'] : 0;
            final bool isGasAlert = data['CanhBaoGas'] == true;
            final bool pirEnabled = data['HeThongPIR'] == true;
            
            // D·ªØ li·ªáu ƒë·∫øm kh√°ch (App t·ª± qu·∫£n l√Ω th√™m)
            final int totalGuests = (data['TongKhach'] is int) ? data['TongKhach'] : 0;

            return SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 25),
              child: Column(
                children: [
                  // 1. C·∫£nh b√°o nguy hi·ªÉm (∆Øu ti√™n cao nh·∫•t)
                  if (isGasAlert)
                    Container(
                      margin: const EdgeInsets.only(bottom: 20),
                      padding: const EdgeInsets.all(15),
                      decoration: BoxDecoration(
                        color: Colors.redAccent,
                        borderRadius: BorderRadius.circular(15),
                        boxShadow: [BoxShadow(color: Colors.red.withOpacity(0.4), blurRadius: 10, spreadRadius: 2)],
                      ),
                      child: Row(
                        children: const [
                          Icon(Icons.warning_amber_rounded, color: Colors.white, size: 40),
                          SizedBox(width: 15),
                          Expanded(
                            child: Text(
                              "C·∫¢NH B√ÅO: R√í R·ªà GAS!\nH·ªá th·ªëng c·ª≠a ƒë√£ m·ªü kh·∫©n c·∫•p.",
                              style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 16),
                            ),
                          ),
                        ],
                      ),
                    ),

                  // 2. Th·∫ª th√¥ng tin m√¥i tr∆∞·ªùng
                  Row(
                    children: [
                      Expanded(child: _buildSensorCard("Nhi·ªát ƒë·ªô", "${temp.toStringAsFixed(1)}¬∞C", Icons.thermostat, Colors.orange)),
                      const SizedBox(width: 15),
                      Expanded(child: _buildSensorCard("ƒê·ªô ·∫©m", "${hum.toStringAsFixed(1)}%", Icons.water_drop, Colors.blue)),
                    ],
                  ),
                  
                  const SizedBox(height: 15),

                  // 3. Th·∫ª n·ªìng ƒë·ªô Gas
                  _buildGasCard(gas),

                  const SizedBox(height: 25),
                  const Text("QU·∫¢N L√ù KH√ÅCH H√ÄNG", style: TextStyle(fontSize: 14, fontWeight: FontWeight.bold, color: Colors.grey)),
                  const SizedBox(height: 10),

                  // 4. B·ªô ƒë·∫øm kh√°ch h√†ng
                  Container(
                    padding: const EdgeInsets.all(20),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(20),
                      boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.03), blurRadius: 10, offset: const Offset(0, 5))]
                    ),
                    width: double.infinity,
                    alignment: Alignment.center,
                    child: _buildAutoCounter("T·ªïng kh√°ch h√¥m nay", totalGuests, Colors.purple),
                  ),

                  const SizedBox(height: 25),
                  const Text("H·ªÜ TH·ªêNG AN NINH", style: TextStyle(fontSize: 14, fontWeight: FontWeight.bold, color: Colors.grey)),
                  const SizedBox(height: 10),

                  // 5. ƒêi·ªÅu khi·ªÉn h·ªá th·ªëng PIR
                  _buildControlSwitch(
                    "Tr·∫°ng th√°i h·ªá th·ªëng", 
                    pirEnabled, 
                    Colors.teal, 
                    () => _dbRef.child('NhaThongMinh/DieuKhien/BatPIR').set(!pirEnabled)
                  ),
                ],
              ),
            );
          }
          return const Center(child: CircularProgressIndicator());
        },
      ),
    );
  }

  Widget _buildSensorCard(String title, String value, IconData icon, Color color) {
    return Container(
      padding: const EdgeInsets.all(15),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(color: Colors.black.withOpacity(0.03), blurRadius: 10, offset: const Offset(0, 5))
        ]
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            padding: const EdgeInsets.all(10),
            decoration: BoxDecoration(
              color: color.withOpacity(0.1),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Icon(icon, color: color, size: 28),
          ),
          const SizedBox(height: 15),
          Text(
            value,
            style: const TextStyle(fontSize: 26, fontWeight: FontWeight.bold, letterSpacing: -0.5),
          ),
          const SizedBox(height: 5),
          Text(title, style: const TextStyle(fontSize: 14, color: Colors.grey, fontWeight: FontWeight.w500)),
        ],
      ),
    );
  }

  Widget _buildGasCard(int gasValue) {
    Color statusColor = gasValue > 1200 ? Colors.red : Colors.green;
    String statusText = gasValue > 1200 ? "NGUY HI·ªÇM" : "An to√†n";

    return Container(
      padding: const EdgeInsets.all(15),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(20),
        boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.03), blurRadius: 10, offset: const Offset(0, 5))]
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(10),
            decoration: BoxDecoration(color: Colors.grey[100], borderRadius: BorderRadius.circular(12)),
            child: const Icon(Icons.cloud, color: Colors.grey, size: 28),
          ),
          const SizedBox(width: 15),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text("N·ªìng ƒë·ªô Kh√≠ Gas", style: TextStyle(fontSize: 14, color: Colors.grey, fontWeight: FontWeight.w500)),
              Text("$gasValue ppm", style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
            ],
          ),
          const Spacer(),
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
            decoration: BoxDecoration(
              color: statusColor.withOpacity(0.1),
              borderRadius: BorderRadius.circular(20),
              border: Border.all(color: statusColor),
            ),
            child: Text(statusText, style: TextStyle(color: statusColor, fontWeight: FontWeight.bold)),
          ),
        ],
      ),
    );
  }

  Widget _buildAutoCounter(String label, int count, Color color) {
    return Column(
      children: [
        Text(label, style: const TextStyle(fontSize: 14, color: Colors.grey)),
        const SizedBox(height: 5),
        Text("$count", style: TextStyle(fontSize: 32, fontWeight: FontWeight.bold, color: color)),
        const SizedBox(height: 5),
        const Text("T·ª± ƒë·ªông ƒë·∫øm", style: TextStyle(fontSize: 12, color: Colors.grey, fontStyle: FontStyle.italic)),
      ],
    );
  }

  Widget _buildControlSwitch(String title, bool value, Color color, VoidCallback onToggle) {
    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(20),
        boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 10, spreadRadius: 1)]
      ),
      child: SwitchListTile(
        contentPadding: const EdgeInsets.symmetric(horizontal: 20, vertical: 5),
        secondary: CircleAvatar(
          backgroundColor: value ? color.withOpacity(0.2) : Colors.grey[200],
          child: Icon(Icons.power_settings_new, color: value ? color : Colors.grey),
        ),
        title: Text(title, style: const TextStyle(fontWeight: FontWeight.bold)),
        subtitle: Text(value ? "H·ªá th·ªëng ƒëang ho·∫°t ƒë·ªông" : "ƒê√£ v√¥ hi·ªáu h√≥a (Kh√≥a c·ª≠a)"),
        value: value,
        onChanged: (val) => onToggle(),
        activeColor: color,
      ),
    );
  }
}

class HistoryScreen extends StatelessWidget {
  const HistoryScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final DatabaseReference dbRef = FirebaseDatabase.instance.ref();

    return Scaffold(
      appBar: AppBar(
        title: const Text("L·ªãch S·ª≠ Ho·∫°t ƒê·ªông"),
        backgroundColor: Theme.of(context).colorScheme.primaryContainer,
      ),
      body: StreamBuilder(
        stream: dbRef.child('History').limitToLast(10).onValue,
        builder: (context, AsyncSnapshot<DatabaseEvent> snapshot) {
          if (snapshot.hasData && snapshot.data!.snapshot.value != null) {
            Map<dynamic, dynamic> rawMap = Map<dynamic, dynamic>.from(snapshot.data!.snapshot.value as Map);
            
            List<MapEntry<dynamic, dynamic>> list = rawMap.entries.toList();
            list.sort((a, b) => b.key.compareTo(a.key));

            return ListView.builder(
              padding: const EdgeInsets.all(16),
              itemCount: list.length,
              itemBuilder: (context, index) {
                String date = list[index].key;
                Map data = list[index].value;
                
                int guests = data['TongKhach'] ?? 0;
                int fires = data['SoLanChay'] ?? 0;
                
                String tMax = (data['NhietDo']?['Max'] ?? 0).toString();
                String tMin = (data['NhietDo']?['Min'] ?? 0).toString();
                String hMax = (data['DoAm']?['Max'] ?? 0).toString();
                String hMin = (data['DoAm']?['Min'] ?? 0).toString();
                String gMax = (data['KhiGas']?['Max'] ?? 0).toString();

                return Container(
                  margin: const EdgeInsets.only(bottom: 15),
                  padding: const EdgeInsets.all(15),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(15),
                    border: Border.all(color: Colors.grey.shade200),
                    boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.03), blurRadius: 5, offset: const Offset(0, 2))],
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text("Ng√†y: $date", style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16, color: Colors.blue)),
                          if (fires > 0)
                            Container(
                              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                              decoration: BoxDecoration(color: Colors.red[100], borderRadius: BorderRadius.circular(8)),
                              child: Text("üî• $fires l·∫ßn ch√°y", style: const TextStyle(color: Colors.red, fontWeight: FontWeight.bold, fontSize: 12)),
                            ),
                        ],
                      ),
                      const Divider(),
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text("Kh√°ch: $guests ng∆∞·ªùi", style: const TextStyle(fontWeight: FontWeight.bold)),
                          const Text("|", style: TextStyle(color: Colors.grey)),
                          Text("Gas Max: $gMax", style: TextStyle(color: int.parse(gMax) > 1000 ? Colors.red : Colors.black)),
                        ],
                      ),
                      const SizedBox(height: 8),
                      Text("Nhi·ªát ƒë·ªô: $tMin - $tMax ¬∞C", style: const TextStyle(fontSize: 13, color: Colors.grey)),
                      Text("ƒê·ªô ·∫©m: $hMin - $hMax %", style: const TextStyle(fontSize: 13, color: Colors.grey)),
                    ],
                  ),
                );
              },
            );
          }
          return const Center(child: Text("Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠", style: TextStyle(color: Colors.grey)));
        },
      ),
    );
  }
}
